package ru.kode.android.build.publish.plugin.play.task.distribution

import org.gradle.api.DefaultTask
import org.gradle.api.GradleException
import org.gradle.api.file.RegularFileProperty
import org.gradle.api.plugins.BasePlugin
import org.gradle.api.provider.Property
import org.gradle.api.tasks.Input
import org.gradle.api.tasks.InputFile
import org.gradle.api.tasks.Internal
import org.gradle.api.tasks.Optional
import org.gradle.api.tasks.TaskAction
import org.gradle.api.tasks.options.Option
import org.gradle.workers.WorkQueue
import org.gradle.workers.WorkerExecutor
import ru.kode.android.build.publish.plugin.core.git.mapper.fromJson
import ru.kode.android.build.publish.plugin.core.util.BUNDLE_FILE_EXTENSION
import ru.kode.android.build.publish.plugin.play.service.network.PlayNetworkService
import ru.kode.android.build.publish.plugin.play.task.distribution.work.PlayUploadWork
import javax.inject.Inject

/**
 * A Gradle task that handles uploading Android App Bundles to the Google Play Store.
 *
 * This task is responsible for:
 * - Validating the input bundle file
 * - Preparing release information from build tags
 * - Submitting the upload work to a background worker
 * - Configuring the target track and update priority
 *
 * The actual upload is performed asynchronously by a Gradle worker to avoid
 * blocking the main build thread.
 *
 * @see <a href="https://github.com/Triple-T/gradle-play-publisher">Gradle Play Publisher</a> for additional functionality
 */
abstract class PlayDistributionTask
    @Inject
    constructor(
        private val workerExecutor: WorkerExecutor,
    ) : DefaultTask() {
        init {
            description = "Uploads Android App Bundles to the Google Play Store"
            group = BasePlugin.BUILD_GROUP
        }

        /**
         * The network service property provides access to the Play Network service used for uploading
         * the distribution file.
         *
         * This property is internal and should not be directly accessed by other plugins. Rather, it is
         * injected by Gradle when the task is created and configured.
         */
        @get:Internal
        abstract val networkService: Property<PlayNetworkService>

        /**
         * The distribution file property contains the Android App Bundle (.aab) file to be uploaded to
         * the Google Play Store.
         *
         * This file must be a valid Android App Bundle and must be specified in the build script.
         * For example, `distributionFile.set(file("path/to/app.aab"))` would set the file to "path/to/app.aab".
         */
        @get:InputFile
        @get:Option(
            option = "distributionFile",
            description = "Artifact output file (absolute path is expected)",
        )
        abstract val distributionFile: RegularFileProperty

        /**
         * The build tag file property contains a JSON file containing information
         * about the last build tag.
         *
         * This file is generated by the
         * [ru.kode.android.build.publish.plugin.foundation.task.tag.GetLastTagSnapshotTask] and
         * contains metadata about the most recent tag that matches the build pattern.
         */
        @get:InputFile
        @get:Option(
            option = "buildTagSnapshotFile",
            description = "Json contains info about tag build",
        )
        abstract val buildTagSnapshotFile: RegularFileProperty

        /**
         * The track ID of the target app. This is the name of the release track
         * that the app bundle will be uploaded to.
         *
         * This property is optional and if not set, the default track name is `internal`.
         *
         * @see <a href="https://support.google.com/googleplay/android-developer/answer/3131213">Google Play Console Help - Release management</a> for more information about tracks.
         */
        @get:Input
        @get:Option(
            option = "trackId",
            description = "Track name of target app. Defaults to internal",
        )
        abstract val trackId: Property<String>

        /**
         * The update priority of the target app. This is the priority that the app
         * bundle will be uploaded with.
         *
         * The update priority is a number between 0 and 5. It determines the order in
         * which the new app bundle will be
         * served to users. App bundles with a higher priority will be served to users sooner.
         *
         * This property is optional and if not set, the default update priority is 0.
         *
         * @see <a href="https://support.google.com/googleplay/android-developer/answer/113476">Google Play Console Help - Update priority</a> for more information about update priorities.
         */
        @get:Input
        @get:Optional
        @get:Option(
            option = "updatePriority",
            description = "Update priority (0..5)",
        )
        abstract val updatePriority: Property<Int>

        /**
         * Executes the Play Store upload process.
         *
         * This method:
         * 1. Validates the input file is an Android App Bundle (.aab)
         * 2. Extracts build information from the build tag
         * 3. Prepares the release name
         * 4. Submits the upload work to a background worker
         *
         * @throws GradleException if the input file is not an Android App Bundle
         */
        @TaskAction
        fun upload() {
            val distributionFile = distributionFile.asFile.get()
            if (distributionFile.extension != BUNDLE_FILE_EXTENSION) {
                throw GradleException(
                    "file ${distributionFile.path} is not bundle, not possible to deploy it to Google Play",
                )
            }
            val currentBuildTag = fromJson(buildTagSnapshotFile.asFile.get()).current
            val releaseName = "${currentBuildTag.name}(${currentBuildTag.buildVersion}.${currentBuildTag.buildNumber})"
            val trackId = trackId.orNull ?: "internal"
            val updatePriority = updatePriority.orNull ?: 0

            val workQueue: WorkQueue = workerExecutor.noIsolation()
            workQueue.submit(PlayUploadWork::class.java) { parameters ->
                parameters.trackId.set(trackId)
                parameters.updatePriority.set(updatePriority)
                parameters.releaseName.set(releaseName)
                parameters.distributionFile.set(distributionFile)
                parameters.networkService.set(networkService)
            }
        }
    }
