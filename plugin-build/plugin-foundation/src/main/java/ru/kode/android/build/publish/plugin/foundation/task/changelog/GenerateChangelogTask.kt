package ru.kode.android.build.publish.plugin.foundation.task.changelog

import org.gradle.api.DefaultTask
import org.gradle.api.file.RegularFileProperty
import org.gradle.api.plugins.BasePlugin
import org.gradle.api.provider.Property
import org.gradle.api.tasks.Input
import org.gradle.api.tasks.InputFile
import org.gradle.api.tasks.Internal
import org.gradle.api.tasks.TaskAction
import org.gradle.api.tasks.options.Option
import org.gradle.work.DisableCachingByDefault
import ru.kode.android.build.publish.plugin.core.git.mapper.fromJson
import ru.kode.android.build.publish.plugin.core.logger.LoggerService
import ru.kode.android.build.publish.plugin.core.strategy.AnnotatedTagMessageStrategy
import ru.kode.android.build.publish.plugin.core.strategy.ChangelogMessageStrategy
import ru.kode.android.build.publish.plugin.core.strategy.EmptyChangelogMessageStrategy
import ru.kode.android.build.publish.plugin.core.strategy.NotGeneratedChangelogMessageStrategy
import ru.kode.android.build.publish.plugin.core.task.GenerateChangelogTaskOutput
import ru.kode.android.build.publish.plugin.foundation.messages.changelogGeneratedMessage
import ru.kode.android.build.publish.plugin.foundation.messages.noChangesChangelogMessage
import ru.kode.android.build.publish.plugin.foundation.service.git.GitExecutorService
import kotlin.io.writeText

/**
 * A Gradle task that generates a changelog file based on Git commit history.
 *
 * This task analyzes the Git commit history between the last tag and the current HEAD,
 * filters commits based on a message key, and generates a changelog file. The generated
 * changelog can be used by other tasks, such as Firebase App Distribution.
 *
 * @see DefaultTask
 * @see GenerateChangelogWork
 */
@DisableCachingByDefault
abstract class GenerateChangelogTask : GenerateChangelogTaskOutput() {
    init {
        description = "Generates a changelog file based on Git commit history"
        group = BasePlugin.BUILD_GROUP
        outputs.upToDateWhen { false }
    }

    /**
     * The Git executor service used to interact with the Git repository.
     *
     * This service provides Git operations needed to retrieve commit history
     * and analyze changes between tags.
     *
     * @see GitExecutorService
     */
    @get:Internal
    abstract val gitExecutorService: Property<GitExecutorService>

    /**
     * The logger service used to log messages during the task execution.
     *
     * This service provides a logger that can be used to log messages during the task execution.
     *
     * @see LoggerService
     */
    @get:Internal
    abstract val loggerService: Property<LoggerService>

    /**
     * Strategy for formatting annotated tag messages in the changelog output.
     */
    @get:Internal
    abstract val annotatedTagMessageStrategy: Property<AnnotatedTagMessageStrategy>

    /**
     * Strategy for formatting commit messages in the changelog output.
     */
    @get:Internal
    abstract val changelogMessageStrategy: Property<ChangelogMessageStrategy>

    /**
     * Strategy for generating changelog messages when no changes are detected.
     */
    @get:Internal
    abstract val emptyChangelogMessageStrategy: Property<EmptyChangelogMessageStrategy>

    /**
     * Strategy for generating changelog messages when the changelog could not be generated.
     */
    @get:Internal
    abstract val notGeneratedChangelogMessageStrategy: Property<NotGeneratedChangelogMessageStrategy>

    /**
     * The JSON file containing information about the last build tag.
     *
     * This file is generated by the [ru.kode.android.build.publish.plugin.foundation.task.tag.GetLastTagSnapshotTask] and contains metadata
     * about the most recent tag that matches the build pattern.
     */
    @get:InputFile
    @get:Option(
        option = "buildTagSnapshotFile",
        description = "JSON file containing build tag information",
    )
    abstract val buildTagSnapshotFile: RegularFileProperty

    /**
     * The key used to filter relevant commit messages.
     *
     * Only commits containing this key in their message will be included
     * in the generated changelog. This helps filter out non-feature or
     * non-bugfix commits.
     *
     * Example: `[changelog]` would match commits with messages like
     * "[changelog] Added new feature" or "Fixed critical bug [changelog]"
     */
    @get:Input
    @get:Option(
        option = "commitMessageKey",
        description = "Key used to filter relevant commit messages",
    )
    abstract val commitMessageKey: Property<String>

    /**
     * The pattern used to match Git tags for versioning.
     *
     * This pattern is used to identify relevant tags when generating the changelog.
     * It should match the pattern used by the [ru.kode.android.build.publish.plugin.foundation.task.tag.GetLastTagSnapshotTask].
     */
    @get:Input
    @get:Option(
        option = "buildTagPattern",
        description = "Pattern used to match Git tags for versioning",
    )
    abstract val buildTagPattern: Property<String>

    /**
     * Executes the changelog generation process.
     *
     * This method:
     * 1. Creates a work queue for background processing
     * 2. Configures and submits a [GenerateChangelogWork] task
     * 3. Passes all necessary parameters to the worker
     *
     * The actual changelog generation happens in a background thread
     * to avoid blocking the main Gradle build thread.
     *
     * @see GenerateChangelogWork
     */
    @TaskAction
    fun generateChangelog() {
        val logger = loggerService.get()

        val commitMessageKey = commitMessageKey.get()
        val buildTagPattern = buildTagPattern.get()
        val tagSnapshot = fromJson(buildTagSnapshotFile.asFile.get())
        val notGeneratedChangelogMessageStrategy = notGeneratedChangelogMessageStrategy.get()
        val emptyChangelogMessageStrategy = emptyChangelogMessageStrategy.get()
        val changelogMessageStrategy = changelogMessageStrategy.get()
        val annotatedTagMessageStrategy = annotatedTagMessageStrategy.get()

        val changelog =
            gitExecutorService.get()
                .gitChangelogBuilder
                .buildForSnapshot(
                    messageKey = commitMessageKey,
                    annotatedTagMessageBuilder = { annotatedTagMessage ->
                        annotatedTagMessageStrategy.build(annotatedTagMessage)
                    },
                    messageBuilder = { message ->
                        changelogMessageStrategy
                            .build(message, commitMessageKey, tagSnapshot)
                    },
                    tagSnapshot = tagSnapshot,
                )
                ?: emptyChangelogMessageStrategy.build(tagSnapshot)

        val changelogOutput = changelogFile.asFile.get()
        val currentBuildTag = tagSnapshot.current

        if (changelog.isBlank()) {
            val noChangesMessage = noChangesChangelogMessage(currentBuildTag)
            logger.quiet(notGeneratedChangelogMessageStrategy.build(buildTagPattern, currentBuildTag))
            changelogOutput.writeText(noChangesMessage)
        } else {
            logger.quiet(changelogGeneratedMessage(buildTagPattern, currentBuildTag))
            changelogOutput.writeText(changelog)
        }
    }
}
