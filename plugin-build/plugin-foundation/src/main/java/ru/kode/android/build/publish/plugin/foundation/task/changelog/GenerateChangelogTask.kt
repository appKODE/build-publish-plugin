package ru.kode.android.build.publish.plugin.foundation.task.changelog

import org.gradle.api.DefaultTask
import org.gradle.api.file.RegularFileProperty
import org.gradle.api.plugins.BasePlugin
import org.gradle.api.provider.Property
import org.gradle.api.services.ServiceReference
import org.gradle.api.tasks.Input
import org.gradle.api.tasks.InputFile
import org.gradle.api.tasks.TaskAction
import org.gradle.api.tasks.options.Option
import org.gradle.work.DisableCachingByDefault
import org.gradle.workers.WorkQueue
import org.gradle.workers.WorkerExecutor
import ru.kode.android.build.publish.plugin.core.logger.LoggerService
import ru.kode.android.build.publish.plugin.core.task.GenerateChangelogTaskOutput
import ru.kode.android.build.publish.plugin.foundation.service.git.GitExecutorService
import ru.kode.android.build.publish.plugin.foundation.task.changelog.work.GenerateChangelogWork
import javax.inject.Inject

/**
 * A Gradle task that generates a changelog file based on Git commit history.
 *
 * This task analyzes the Git commit history between the last tag and the current HEAD,
 * filters commits based on a message key, and generates a changelog file. The generated
 * changelog can be used by other tasks, such as Firebase App Distribution.
 *
 * @see DefaultTask
 * @see GenerateChangelogWork
 */
@DisableCachingByDefault
abstract class GenerateChangelogTask
    @Inject
    constructor(
        private val workerExecutor: WorkerExecutor,
    ) : GenerateChangelogTaskOutput() {
        init {
            description = "Generates a changelog file based on Git commit history"
            group = BasePlugin.BUILD_GROUP
            outputs.upToDateWhen { false }
        }

        /**
         * The Git executor service used to interact with the Git repository.
         *
         * This service provides Git operations needed to retrieve commit history
         * and analyze changes between tags.
         *
         * @see GitExecutorService
         */
        @get:ServiceReference
        abstract val gitExecutorService: Property<GitExecutorService>

        /**
         * The logger service used to log messages during the task execution.
         *
         * This service provides a logger that can be used to log messages during the task execution.
         *
         * @see LoggerService
         */
        @get:ServiceReference
        abstract val loggerService: Property<LoggerService>

        /**
         * The JSON file containing information about the last build tag.
         *
         * This file is generated by the [ru.kode.android.build.publish.plugin.foundation.task.tag.GetLastTagSnapshotTask] and contains metadata
         * about the most recent tag that matches the build pattern.
         */
        @get:InputFile
        @get:Option(
            option = "buildTagSnapshotFile",
            description = "JSON file containing build tag information",
        )
        abstract val buildTagSnapshotFile: RegularFileProperty

        /**
         * The key used to filter relevant commit messages.
         *
         * Only commits containing this key in their message will be included
         * in the generated changelog. This helps filter out non-feature or
         * non-bugfix commits.
         *
         * Example: `[changelog]` would match commits with messages like
         * "[changelog] Added new feature" or "Fixed critical bug [changelog]"
         */
        @get:Input
        @get:Option(
            option = "commitMessageKey",
            description = "Key used to filter relevant commit messages",
        )
        abstract val commitMessageKey: Property<String>

        /**
         * Whether to remove the [commitMessageKey] from commit messages in the generated changelog.
         *
         * When enabled (`true`), the [commitMessageKey] (for example `[changelog]`)
         * will be stripped from commit messages before writing them to the changelog.
         * When disabled (`false`), the key remains visible in the generated changelog output.
         *
         * This allows using a marker key to identify relevant commits without exposing
         * that internal tag in the final changelog.
         *
         * Example:
         * - `commitMessageKey = "[changelog]"`
         * - `excludeMessageKey = true`
         *
         * Commit message:
         * ```
         * [changelog] Fix crash on startup
         * ```
         * will appear as:
         * ```
         * Fix crash on startup
         * ```
         * in the generated changelog.
         */
        @get:Input
        @get:Option(
            option = "excludeMessageKey",
            description = "Exclude key from changelog or not",
        )
        abstract val excludeMessageKey: Property<Boolean>

        /**
         * The pattern used to match Git tags for versioning.
         *
         * This pattern is used to identify relevant tags when generating the changelog.
         * It should match the pattern used by the [ru.kode.android.build.publish.plugin.foundation.task.tag.GetLastTagSnapshotTask].
         */
        @get:Input
        @get:Option(
            option = "buildTagPattern",
            description = "Pattern used to match Git tags for versioning",
        )
        abstract val buildTagPattern: Property<String>

        /**
         * Executes the changelog generation process.
         *
         * This method:
         * 1. Creates a work queue for background processing
         * 2. Configures and submits a [GenerateChangelogWork] task
         * 3. Passes all necessary parameters to the worker
         *
         * The actual changelog generation happens in a background thread
         * to avoid blocking the main Gradle build thread.
         *
         * @see GenerateChangelogWork
         */
        @TaskAction
        fun generateChangelog() {
            val workQueue: WorkQueue = workerExecutor.noIsolation()
            workQueue.submit(GenerateChangelogWork::class.java) { parameters ->
                parameters.commitMessageKey.set(commitMessageKey)
                parameters.excludeMessageKey.set(excludeMessageKey)
                parameters.buildTagPattern.set(buildTagPattern)
                parameters.buildTagSnapshotFile.set(buildTagSnapshotFile)
                parameters.changelogFile.set(changelogFile)
                parameters.gitExecutorService.set(gitExecutorService)
                parameters.loggerService.set(loggerService)
            }
        }
    }
