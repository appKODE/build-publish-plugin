package ru.kode.android.build.publish.plugin.telegram.task.changelog

import org.gradle.api.DefaultTask
import org.gradle.api.file.RegularFileProperty
import org.gradle.api.plugins.BasePlugin
import org.gradle.api.provider.Property
import org.gradle.api.provider.SetProperty
import org.gradle.api.services.ServiceReference
import org.gradle.api.tasks.Input
import org.gradle.api.tasks.InputFile
import org.gradle.api.tasks.Internal
import org.gradle.api.tasks.TaskAction
import org.gradle.api.tasks.options.Option
import org.gradle.workers.WorkQueue
import org.gradle.workers.WorkerExecutor
import ru.kode.android.build.publish.plugin.core.git.mapper.fromJson
import ru.kode.android.build.publish.plugin.core.logger.LoggerService
import ru.kode.android.build.publish.plugin.telegram.config.DestinationTelegramBotConfig
import ru.kode.android.build.publish.plugin.telegram.messages.failedToReadChangelogFile
import ru.kode.android.build.publish.plugin.telegram.service.TelegramService
import ru.kode.android.build.publish.plugin.telegram.task.changelog.work.SendTelegramChangelogWork
import javax.inject.Inject

/**
 * A Gradle task that sends changelog notifications to Telegram.
 *
 * This task is responsible for processing and sending changelog notifications to configured
 * Telegram chats. It handles various aspects of message preparation and delivery:
 *
 * ## Features
 * - Reads changelog content from a file
 * - Formats issue references as clickable links using the configured issue tracker URL
 * - Escapes special characters for Telegram's MarkdownV2 format
 * - Splits long messages to fit Telegram's 4096 character limit
 * - Includes user mentions at the beginning of the message
 * - Sends notifications asynchronously using Gradle's worker API
 * - Supports multiple destination chats and bots
 *
 * @see TelegramService For the underlying network communication
 * @see SendTelegramChangelogWork For the actual work implementation
 */
abstract class SendTelegramChangelogTask
    @Inject
    constructor(
        private val workerExecutor: WorkerExecutor,
    ) : DefaultTask() {
        init {
            description = "Task to send changelog for Telegram"
            group = BasePlugin.BUILD_GROUP
        }

        /**
         * The network service property provides access to the Telegram network service used for sending
         * changelog notifications.
         *
         * This property is internal and should not be directly accessed by other plugins. Rather, it is
         * injected by Gradle when the task is created and configured.
         *
         * @see TelegramService For the actual network service implementation
         */
        @get:Internal
        abstract val service: Property<TelegramService>

        /**
         * The logger service property provides access to the logger service used for logging operations
         * within the task.
         *
         * This property is internal and should not be directly accessed by other plugins. Rather, it is
         * injected by Gradle when the task is created and configured.
         *
         * @see LoggerService For the actual logger service implementation
         */
        @get:ServiceReference
        abstract val loggerService: Property<LoggerService>

        /**
         * The changelog file property contains the path to the file containing the changelog text to be sent.
         *
         * This file should contain the raw changelog text that will be formatted and sent to Telegram.
         * The file is expected to be in plain text format.
         */
        @get:InputFile
        @get:Option(
            option = "changelogFile",
            description = "File with saved changelog",
        )
        abstract val changelogFile: RegularFileProperty

        /**
         * The build tag file property contains a JSON file with information about the current build tag.
         *
         * This file is generated by the build process and contains metadata about the current build,
         * including version information and build number.
         */
        @get:InputFile
        @get:Option(
            option = "buildTagFile",
            description = "Json contains info about tag build",
        )
        abstract val buildTagFile: RegularFileProperty

        /**
         * The base output file name property specifies the base name used for the build output.
         *
         * This is typically the application ID or name that will be included in the Telegram message
         * to identify which application the changelog belongs to.
         */
        @get:Input
        @get:Option(
            option = "baseOutputFileName",
            description = "Application bundle name for changelog",
        )
        abstract val baseOutputFileName: Property<String>

        /**
         * The issue URL prefix property defines the base URL for issue tracker links.
         *
         * This URL is used to convert issue references (e.g., #123) in the changelog into clickable
         * links in the Telegram message.
         */
        @get:Input
        @get:Option(
            option = "issueUrlPrefix",
            description = "Address of task tracker",
        )
        abstract val issueUrlPrefix: Property<String>

        /**
         * The issue number pattern property defines the regular expression pattern used to identify
         * issue references in the changelog text.
         *
         * This pattern is used to detect and convert issue numbers into clickable links using the
         * configured issue URL prefix.
         */
        @get:Input
        @get:Option(
            option = "issueNumberPattern",
            description = "How task number formatted",
        )
        abstract val issueNumberPattern: Property<String>

        /**
         * The user mentions property contains a set of usernames or groups to be mentioned in the
         * Telegram message.
         *
         * These mentions will be included at the beginning of the message to notify specific users
         * or groups about the changelog update.
         */
        @get:Input
        @get:Option(
            option = "userMentions",
            description = "User tags to mention in chat",
        )
        abstract val userMentions: SetProperty<String>

        /**
         * The destination bots property defines which Telegram bots and chats should receive the changelog.
         *
         * This set contains [DestinationTelegramBotConfig] objects, each specifying a bot configuration and the
         * list of chat names where the message should be sent.
         */
        @get:Input
        @get:Option(
            option = "destinationBots",
            description = "Bots which be used to post changelog",
        )
        abstract val destinationBots: Property<String>

        /**
         * Executes the changelog sending process.
         *
         * This is the main entry point for the task, called by Gradle when the task is executed.
         * It coordinates the entire process of reading, formatting, and sending the changelog.
         *
         * ## Process Flow
         * 1. Reads build tag information (version, build number) from the build tag file
         * 2. Validates that the changelog file exists and has content
         * 3. Formats issue references as clickable links using the configured pattern
         * 4. Escapes special characters for Telegram's MarkdownV2 format
         * 5. Splits the message into chunks if it exceeds Telegram's length limit
         * 6. Submits each chunk to a background worker for sending
         *
         * ## Error Handling
         * - Logs an error if the changelog file is empty or missing
         * - Handles network errors through the underlying network service
         *
         * @throws IllegalStateException If required configuration is missing
         * @throws IOException If there's an error reading the changelog file
         */
        @TaskAction
        fun sendChangelog() {
            val currentBuildTag = fromJson(buildTagFile.asFile.get())

            val changelogFile = changelogFile.asFile.orNull
            val changelog = changelogFile?.readText()
            if (changelog.isNullOrEmpty()) {
                loggerService.get().error(failedToReadChangelogFile(changelogFile))
            } else {
                val workQueue: WorkQueue = workerExecutor.noIsolation()
                workQueue.submit(SendTelegramChangelogWork::class.java) { parameters ->
                    parameters.baseOutputFileName.set(baseOutputFileName)
                    parameters.buildName.set(currentBuildTag.name)
                    parameters.changelog.set(changelog)
                    parameters.userMentions.set(userMentions)
                    parameters.destinationBots.set(destinationBots)
                    parameters.service.set(service)
                    parameters.loggerService.set(loggerService)
                    parameters.issueUrlPrefix.set(issueUrlPrefix)
                    parameters.issueNumberPattern.set(issueNumberPattern)
                }
            }
        }
    }
